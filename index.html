
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Candlestick Course | Trust Wallet DApp</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg-dark: #0a0e17;
      --bg-card: #12182a;
      --bg-card-hover: #1a2338;
      --accent: #00d4aa;
      --accent-dim: rgba(0, 212, 170, 0.15);
      --accent-bright: #00ffcc;
      --text: #e8ecf4;
      --text-muted: #8b95a8;
      --border: rgba(255, 255, 255, 0.08);
      --success: #00d4aa;
      --warning: #ffc107;
      --danger: #ff5252;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Outfit', sans-serif;
      background: var(--bg-dark);
      color: var(--text);
      min-height: 100vh;
      padding: 24px;
      background-image: 
        radial-gradient(ellipse 80% 50% at 50% -20%, rgba(0, 212, 170, 0.12), transparent),
        radial-gradient(ellipse 60% 40% at 80% 100%, rgba(255, 193, 7, 0.08), transparent);
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 32px;
      margin-bottom: 24px;
      transition: all 0.3s ease;
    }
    .card:hover {
      border-color: rgba(0, 212, 170, 0.3);
      box-shadow: 0 8px 32px rgba(0, 212, 170, 0.1);
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }
    h1 {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 8px;
      letter-spacing: -0.02em;
      background: linear-gradient(135deg, var(--accent), var(--accent-bright));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    h2 {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 16px;
    }
    h3 {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 12px;
    }
    .subtitle {
      color: var(--text-muted);
      font-size: 0.95rem;
      margin-bottom: 24px;
    }
    .wallet-info {
      background: var(--accent-dim);
      border: 1px solid rgba(0, 212, 170, 0.3);
      border-radius: 12px;
      padding: 12px 16px;
      margin-bottom: 24px;
      font-size: 0.9rem;
      color: var(--accent);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 14px 28px;
      font-size: 1rem;
      font-weight: 500;
      font-family: inherit;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .btn-primary {
      background: var(--accent);
      color: var(--bg-dark);
    }
    .btn-primary:hover:not(:disabled) {
      background: var(--accent-bright);
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0, 212, 170, 0.4);
    }
    .btn-outline {
      background: transparent;
      color: var(--accent);
      border: 2px solid var(--accent);
    }
    .btn-outline:hover:not(:disabled) {
      background: var(--accent-dim);
    }
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .hidden { display: none !important; }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }
    .stat-card {
      background: linear-gradient(135deg, rgba(0, 212, 170, 0.1), rgba(0, 255, 204, 0.05));
      border: 1px solid rgba(0, 212, 170, 0.2);
      border-radius: 16px;
      padding: 20px;
      text-align: center;
    }
    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 8px;
    }
    .stat-label {
      font-size: 0.9rem;
      color: var(--text-muted);
    }
    .chart-container {
      position: relative;
      height: 300px;
      margin-top: 24px;
    }
    .affiliate-link-box {
      background: rgba(0, 0, 0, 0.3);
      border: 1px dashed var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }
    .affiliate-link-box input {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: rgba(0, 0, 0, 0.3);
      color: var(--text);
      font-size: 0.9rem;
      font-family: 'Courier New', monospace;
    }
    .level-badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      background: var(--accent-dim);
      color: var(--accent);
      margin-left: 8px;
    }
    .team-size {
      font-size: 1.1rem;
      color: var(--accent);
      font-weight: 600;
    }
    .date-range {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-top: 8px;
    }
    .location-header {
      text-align: center;
      padding: 12px 24px;
      margin-bottom: 24px;
      font-size: 1rem;
      font-weight: 500;
      color: var(--accent);
      background: var(--accent-dim);
      border: 1px solid rgba(0, 212, 170, 0.3);
      border-radius: 12px;
    }
    .location-header.loading {
      color: var(--text-muted);
    }
  </style>
</head>
<body>
  <div id="locationHeader" class="location-header loading">Detecting location...</div>
  <div class="container">
    <!-- Connect Section -->
    <div id="connectSection" class="card">
      <h1>üìà Candlestick Trading Course</h1>
      <p class="subtitle">Master professional candlestick patterns and unlock profitable trading strategies</p>
      <button id="connectBtn" class="btn btn-primary" style="width: 100%;">
        Connect Trust Wallet
      </button>
    </div>

    <!-- Main Dashboard -->
    <div id="mainSection" class="hidden">
      <!-- Header -->
      <div class="card">
        <div class="card-header">
          <div>
            <h2>Dashboard</h2>
            <div class="wallet-info">
              <span id="walletAddress"></span>
              <button id="disconnectBtn" class="btn btn-outline" style="padding: 8px 16px; font-size: 0.9rem;">Disconnect</button>
            </div>
          </div>
        </div>

        <!-- Course Unlock Section -->
        <div id="unlockSection">
          <h3>üîì Unlock Premium Course</h3>
          <p class="subtitle">Pay 10 USDT to access the complete candlestick trading course</p>
          <button id="payBtn" class="btn btn-primary" style="width: 100%;">Pay 10 USDT to Unlock Course</button>
        </div>

        <!-- Thank You Section -->
        <div id="thankyouSection" class="hidden">
          <h2 style="color: var(--accent);">‚úÖ Course Unlocked!</h2>
          <p class="subtitle">You now have full access to the candlestick trading course. Start learning and start earning!</p>
        </div>
      </div>

      <!-- Affiliate Link Section -->
      <div id="affiliateSection" class="card hidden">
        <h3>üîó Your Affiliate Link</h3>
        <p class="subtitle">Share your link and earn 50% from each sale, plus commissions from 3 levels!</p>
        <div class="affiliate-link-box">
          <input id="affiliateLink" type="text" readonly>
        </div>
        <button id="copyAffiliateBtn" class="btn btn-outline" style="width: 100%;">Copy Affiliate Link</button>
      </div>

      <!-- Earnings Dashboard -->
      <div id="dashboardSection" class="card hidden">
        <h2>üí∞ Earnings Dashboard</h2>
        
        <!-- Total Stats -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="totalEarnings">5,600</div>
            <div class="stat-label">Total Earnings (USDT)</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="totalSales">105</div>
            <div class="stat-label">Total Sales</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="teamSize">42</div>
            <div class="stat-label">Team Size</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="rewardPoolEarnings">6,385</div>
            <div class="stat-label">Reward Pool Earnings</div>
          </div>
        </div>

        <!-- Level Earnings -->
        <h3 style="margin-top: 32px;">üìä Earnings by Level</h3>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="level1Earnings" style="color: #00ffcc;">525</div>
            <div class="stat-label">Level 1 Earnings <span class="level-badge">20%</span></div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="level2Earnings" style="color: #00d4aa;">1,038</div>
            <div class="stat-label">Level 2 Earnings <span class="level-badge">10%</span></div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="level3Earnings" style="color: #00b894;">4,037</div>
            <div class="stat-label">Level 3 Earnings <span class="level-badge">10%</span></div>
          </div>
        </div>

        <!-- How Earnings Work Section -->
        <div style="margin-top: 32px; padding: 24px; background: linear-gradient(135deg, rgba(0, 212, 170, 0.1), rgba(0, 255, 204, 0.05)); border: 1px solid rgba(0, 212, 170, 0.2); border-radius: 16px;">
          <h3 style="color: var(--accent); margin-bottom: 16px;">üí° How Multi-Level Earnings Work</h3>
          <p style="color: var(--text-muted); margin-bottom: 20px; line-height: 1.6;">
            When someone purchases the course using your affiliate link, you earn commissions from multiple levels:
          </p>
          <div style="display: grid; gap: 16px;">
            <div style="padding: 16px; background: rgba(0, 0, 0, 0.3); border-radius: 12px; border-left: 4px solid #00ffcc;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <strong style="color: var(--accent);">Direct Sale (You)</strong>
                <span style="color: #00ffcc; font-weight: 600;">50% = 5 USDT</span>
              </div>
              <p style="color: var(--text-muted); font-size: 0.9rem;">When someone buys directly through your link</p>
            </div>
            <div style="padding: 16px; background: rgba(0, 0, 0, 0.3); border-radius: 12px; border-left: 4px solid #00d4aa;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <strong style="color: var(--accent);">Level 1 (Your Direct Referrals)</strong>
                <span style="color: #00d4aa; font-weight: 600;">20% = 2 USDT</span>
              </div>
              <p style="color: var(--text-muted); font-size: 0.9rem;">When someone you referred makes a sale</p>
            </div>
            <div style="padding: 16px; background: rgba(0, 0, 0, 0.3); border-radius: 12px; border-left: 4px solid #00b894;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <strong style="color: var(--accent);">Level 2 (Your Referral's Referrals)</strong>
                <span style="color: #00b894; font-weight: 600;">10% = 1 USDT</span>
              </div>
              <p style="color: var(--text-muted); font-size: 0.9rem;">When your Level 1 referrals make sales</p>
            </div>
            <div style="padding: 16px; background: rgba(0, 0, 0, 0.3); border-radius: 12px; border-left: 4px solid #00a085;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <strong style="color: var(--accent);">Level 3 (Deep Network)</strong>
                <span style="color: #00a085; font-weight: 600;">10% = 1 USDT</span>
              </div>
              <p style="color: var(--text-muted); font-size: 0.9rem;">When your Level 2 referrals make sales</p>
            </div>
          </div>
          <div style="margin-top: 20px; padding: 16px; background: rgba(0, 212, 170, 0.15); border-radius: 12px;">
            <p style="color: var(--accent); font-weight: 600; margin-bottom: 8px;">üìà Maximum Potential per Sale:</p>
            <p style="color: var(--text); font-size: 1.1rem;">
              <strong>5 USDT (Direct) + 2 USDT (L1) + 1 USDT (L2) + 1 USDT (L3) = 9 USDT per sale</strong>
            </p>
            <p style="color: var(--text-muted); font-size: 0.9rem; margin-top: 8px;">
              The remaining 10% goes to the Reward Pool for bonus distributions
            </p>
          </div>
        </div>

        <!-- Earnings Chart -->
        <h3 style="margin-top: 32px;">üìà Earnings Over Time</h3>
        <div class="chart-container">
          <canvas id="earningsChart"></canvas>
        </div>
        <div class="date-range">Date Range: Feb 1, 2026 - Feb 6, 2026</div>

        <!-- Reward Pool Section -->
        <div style="margin-top: 32px; padding: 24px; background: linear-gradient(135deg, rgba(255, 193, 7, 0.1), rgba(255, 193, 7, 0.05)); border: 1px solid rgba(255, 193, 7, 0.2); border-radius: 16px;">
          <h3 style="color: var(--warning); margin-bottom: 16px;">üéÅ Reward Pool Explained</h3>
          <div class="stat-value" style="color: var(--warning); font-size: 2.5rem; margin-bottom: 20px;">6,385 USDT</div>
          
          <div style="margin-bottom: 20px;">
            <h4 style="color: var(--warning); margin-bottom: 12px; font-size: 1.1rem;">How the Reward Pool Works:</h4>
            <div style="display: grid; gap: 12px;">
              <div style="padding: 12px; background: rgba(0, 0, 0, 0.3); border-radius: 8px;">
                <p style="color: var(--text); margin-bottom: 4px;">
                  <strong>üí∞ Pool Funding:</strong> 10% of every course sale (1 USDT per sale) goes into the Reward Pool
                </p>
              </div>
              <div style="padding: 12px; background: rgba(0, 0, 0, 0.3); border-radius: 8px;">
                <p style="color: var(--text); margin-bottom: 4px;">
                  <strong>üéØ Distribution Criteria:</strong> Rewards are distributed to users based on:
                </p>
                <ul style="color: var(--text-muted); margin-left: 20px; margin-top: 8px; line-height: 1.8;">
                  <li>Early platform joiners (first 1000 members get priority)</li>
                  <li>Top performers with highest sales volume</li>
                  <li>Active affiliates who consistently refer new users</li>
                  <li>Random bonus distributions to reward community engagement</li>
                </ul>
              </div>
              <div style="padding: 12px; background: rgba(0, 0, 0, 0.3); border-radius: 8px;">
                <p style="color: var(--text); margin-bottom: 4px;">
                  <strong>‚è∞ Distribution Schedule:</strong> Reward Pool distributions happen weekly, with bonus distributions on special occasions
                </p>
              </div>
              <div style="padding: 12px; background: rgba(255, 193, 7, 0.15); border-radius: 8px; border: 1px solid rgba(255, 193, 7, 0.3);">
                <p style="color: var(--warning); font-weight: 600; margin-bottom: 4px;">
                  üí° Pro Tip:
                </p>
                <p style="color: var(--text);">
                  The more active you are in referring users and making sales, the higher your chances of receiving Reward Pool bonuses!
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/ethers@6.9.0/dist/ethers.umd.min.js"></script>
  <script>
    const BSC_CHAIN_ID = '0x38';
    const BSC_PARAMS = {
      chainId: BSC_CHAIN_ID,
      chainName: 'BNB Smart Chain',
      nativeCurrency: { name: 'BNB', symbol: 'BNB', decimals: 18 },
      rpcUrls: ['https://bsc-dataseed.binance.org/'],
      blockExplorerUrls: ['https://bscscan.com/']
    };
    const USDT_ADDRESS = '0x55d398326f99059fF775485246999027B3197955';
    const RECIPIENT_ADDRESS = '0xd08c6432FbD2c066e2a2B5B2b1546F5a05e0B8e2';
    const PAYMENT_AMOUNT = '10';
    const USDT_DECIMALS = 18;

    let provider, signer, userAddress;
    let earningsChart = null;

    const DEFAULT_STATS = {
      totalEarnings: 5600,
      totalSales: 105,
      teamSize: 42,
      rewardPoolEarnings: 6385,
      level1: 525,
      level2: 1038,
      level3: 4037,
      earnings: [
        { date: '2026-02-01', label: 'Feb 1', value: 850 },
        { date: '2026-02-02', label: 'Feb 2', value: 1200 },
        { date: '2026-02-03', label: 'Feb 3', value: 980 },
        { date: '2026-02-04', label: 'Feb 4', value: 1450 },
        { date: '2026-02-05', label: 'Feb 5', value: 1120 },
        { date: '2026-02-06', label: 'Feb 6', value: 0 }
      ]
    };

    function loadStats() {
      try {
        const raw = localStorage.getItem('dreamStats');
        if (!raw) return DEFAULT_STATS;
        const parsed = JSON.parse(raw);
        return {
          ...DEFAULT_STATS,
          ...parsed,
          earnings: Array.isArray(parsed.earnings) && parsed.earnings.length
            ? parsed.earnings
            : DEFAULT_STATS.earnings
        };
      } catch {
        return DEFAULT_STATS;
      }
    }

    const stats = loadStats();

    const earningsData = {
      dates: stats.earnings.map(e => e.label),
      values: stats.earnings.map(e => e.value)
    };

    const connectBtn = document.getElementById('connectBtn');
    const connectSection = document.getElementById('connectSection');
    const mainSection = document.getElementById('mainSection');
    const walletAddressEl = document.getElementById('walletAddress');
    const payBtn = document.getElementById('payBtn');
    const unlockSection = document.getElementById('unlockSection');
    const thankyouSection = document.getElementById('thankyouSection');
    const affiliateSection = document.getElementById('affiliateSection');
    const affiliateLinkInput = document.getElementById('affiliateLink');
    const copyAffiliateBtn = document.getElementById('copyAffiliateBtn');
    const dashboardSection = document.getElementById('dashboardSection');
    const disconnectBtn = document.getElementById('disconnectBtn');
    const totalEarningsEl = document.getElementById('totalEarnings');
    const totalSalesEl = document.getElementById('totalSales');
    const teamSizeEl = document.getElementById('teamSize');
    const rewardPoolEarningsEl = document.getElementById('rewardPoolEarnings');
    const level1EarningsEl = document.getElementById('level1Earnings');
    const level2EarningsEl = document.getElementById('level2Earnings');
    const level3EarningsEl = document.getElementById('level3Earnings');

    function formatNumber(value) {
      const n = Number(value);
      if (Number.isNaN(n)) return String(value);
      return n.toLocaleString();
    }

    function applyStatsToDom() {
      if (totalEarningsEl) totalEarningsEl.textContent = formatNumber(stats.totalEarnings);
      if (totalSalesEl) totalSalesEl.textContent = formatNumber(stats.totalSales);
      if (teamSizeEl) teamSizeEl.textContent = formatNumber(stats.teamSize);
      if (rewardPoolEarningsEl) rewardPoolEarningsEl.textContent = formatNumber(stats.rewardPoolEarnings);
      if (level1EarningsEl) level1EarningsEl.textContent = formatNumber(stats.level1);
      if (level2EarningsEl) level2EarningsEl.textContent = formatNumber(stats.level2);
      if (level3EarningsEl) level3EarningsEl.textContent = formatNumber(stats.level3);
    }

    async function checkVpn(ip) {
      if (!ip) return false;
      try {
        const res = await fetch(`https://proxycheck.io/v2/${ip}?vpn=1&asn=0`, { method: 'GET' });
        const data = await res.json();
        if (data && data[ip]) {
          return data[ip].proxy === 'yes';
        }
      } catch (_) {}
      return false;
    }

    async function updateLocationHeader() {
      const el = document.getElementById('locationHeader');
      if (!el) return;
      try {
        const res = await fetch('https://ipapi.co/json/');
        const data = await res.json();
        const country = (data.country_code || '').toUpperCase();
        const ip = data.ip || '';
        let locationText = '';
        if (country === 'IN') {
          locationText = 'You are in india';
        } else if (country === 'CA') {
          locationText = 'You are in canada';
        } else {
          locationText = 'You are outside';
        }
        el.classList.remove('loading');
        const vpnDetected = await checkVpn(ip);
        el.textContent = vpnDetected ? locationText + ' ¬∑ VPN detected' : locationText;
      } catch (_) {
        el.classList.remove('loading');
        el.textContent = 'You are outside';
      }
    }

    function showThankYou() {
      unlockSection.classList.add('hidden');
      thankyouSection.classList.remove('hidden');
      affiliateSection.classList.remove('hidden');
      dashboardSection.classList.remove('hidden');
      initChart();
    }

    function initChart() {
      const ctx = document.getElementById('earningsChart');
      if (!ctx || earningsChart) return;
      
      earningsChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: earningsData.dates,
          datasets: [{
            label: 'Daily Earnings (USDT)',
            data: earningsData.values,
            borderColor: '#00d4aa',
            backgroundColor: 'rgba(0, 212, 170, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointRadius: 6,
            pointHoverRadius: 8,
            pointBackgroundColor: '#00d4aa',
            pointBorderColor: '#00ffcc',
            pointBorderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              labels: {
                color: '#e8ecf4',
                font: { family: 'Outfit', size: 14 }
              }
            },
            tooltip: {
              backgroundColor: 'rgba(18, 24, 42, 0.95)',
              titleColor: '#e8ecf4',
              bodyColor: '#00d4aa',
              borderColor: '#00d4aa',
              borderWidth: 1,
              padding: 12,
              displayColors: false,
              callbacks: {
                label: function(context) {
                  return 'Earnings: ' + context.parsed.y + ' USDT';
                }
              }
            }
          },
          scales: {
            x: {
              ticks: { color: '#8b95a8', font: { family: 'Outfit' } },
              grid: { color: 'rgba(255, 255, 255, 0.05)' }
            },
            y: {
              ticks: { 
                color: '#8b95a8', 
                font: { family: 'Outfit' },
                callback: function(value) { return value + ' USDT'; }
              },
              grid: { color: 'rgba(255, 255, 255, 0.05)' }
            }
          }
        }
      });
    }

    async function connectWallet() {
      if (!window.ethereum) {
        alert('Please install Trust Wallet or another Web3 wallet to use this DApp.');
        return;
      }
      try {
        provider = new ethers.BrowserProvider(window.ethereum);
        const network = await provider.getNetwork();
        if (network.chainId !== BigInt(parseInt(BSC_CHAIN_ID, 16))) {
          try {
            await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: BSC_CHAIN_ID }] });
          } catch (e) {
            if (e.code === 4902) {
              await window.ethereum.request({ method: 'wallet_addEthereumChain', params: [BSC_PARAMS] });
            } else throw e;
          }
          provider = new ethers.BrowserProvider(window.ethereum);
        }
        signer = await provider.getSigner();
        userAddress = await signer.getAddress();
        walletAddressEl.textContent = userAddress.slice(0, 6) + '...' + userAddress.slice(-4);
        
        connectSection.classList.add('hidden');
        mainSection.classList.remove('hidden');
        applyStatsToDom();
        
        // Show affiliate link
        if (affiliateSection && affiliateLinkInput) {
          const baseUrl = window.location.origin + window.location.pathname;
          affiliateLinkInput.value = `${baseUrl}?ref=${userAddress}`;
          affiliateSection.classList.remove('hidden');
        }
        
        // For demo: show dashboard immediately (in real app, check if paid)
        showThankYou();
      } catch (err) {
        console.error(err);
        alert('Failed to connect: ' + (err.message || err));
      }
    }

    async function payAndUnlock() {
      if (!signer) return;
      payBtn.disabled = true;
      try {
        const usdt = new ethers.Contract(USDT_ADDRESS, [
          'function transfer(address to, uint256 amount) returns (bool)',
          'function balanceOf(address account) view returns (uint256)'
        ], signer);
        const amount = ethers.parseUnits(PAYMENT_AMOUNT, USDT_DECIMALS);
        const balance = await usdt.balanceOf(userAddress);
        if (balance < amount) {
          alert('Insufficient USDT balance. You need at least 10 USDT.');
          payBtn.disabled = false;
          return;
        }
        const tx = await usdt.transfer(RECIPIENT_ADDRESS, amount);
        await tx.wait();
        showThankYou();
      } catch (err) {
        console.error(err);
        alert(err.message || 'Transaction failed. Please try again.');
      }
      payBtn.disabled = false;
    }

    function disconnect() {
      provider = signer = userAddress = null;
      connectSection.classList.remove('hidden');
      mainSection.classList.add('hidden');
      if (earningsChart) {
        earningsChart.destroy();
        earningsChart = null;
      }
    }

    function copyAffiliateLink() {
      affiliateLinkInput.select();
      document.execCommand('copy');
      copyAffiliateBtn.textContent = 'Copied!';
      setTimeout(() => {
        copyAffiliateBtn.textContent = 'Copy Affiliate Link';
      }, 2000);
    }

    connectBtn.addEventListener('click', connectWallet);
    payBtn.addEventListener('click', payAndUnlock);
    disconnectBtn.addEventListener('click', disconnect);
    copyAffiliateBtn.addEventListener('click', copyAffiliateLink);

    // Auto-connect on load if previously connected
    async function init() {
      if (!window.ethereum) return;
      try {
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        if (accounts && accounts.length > 0) {
          await connectWallet();
        }
      } catch (_) {}
    }
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        init();
        updateLocationHeader();
      });
    } else {
      init();
      updateLocationHeader();
    }
  </script>
</body>
</html>
